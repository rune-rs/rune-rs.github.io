<!DOCTYPE html>
<html lang="en">
    <head>
      
        <meta http-equiv="X-UA-Compatible" content="IE=edge" >
        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <!-- SEO -->
        
        <title> This month and a half in Rune | The Rune Programming Language </title>
        

        <!-- Enable responsiveness on mobile devices-->
        <meta name="viewport"  content="width=device-width, initial-scale=1.0, maximum-scale=1" >

        <!--  css -->
        <link rel="stylesheet"  href="https:&#x2F;&#x2F;rune-rs.github.io/style.css" >

        <!-- fonts -->
        <!-- preload  -->
        <link rel="preload" href="https://fonts.googleapis.com/css?family=Montserrat:200,300,300i,400,500,500i,600,700,800,900|Raleway" as="style">
        <link rel="preload"  href="https://use.fontawesome.com/releases/v6.4.2/css/all.css" crossorigin="anonymous" as="style" >
        <!-- load -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:200,300,300i,400,500,500i,600,700,800,900|Raleway">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.4.2/css/all.css" crossorigin="anonymous">
      

      
        <link rel="alternate" type="application/rss+xml" title="RSS" href="https://rune-rs.github.io/rss.xml">
      
    </head>

    <body>
      
<header>
  <nav id="overlord" class="overlord" >
    
<img class="mini-logo " src="https:&#x2F;&#x2F;rune-rs.github.io/img/logo.png"></img>
<span class="mini-logo-title">
    <a href="https:&#x2F;&#x2F;rune-rs.github.io">The Rune Programming Language</a>
</span>

  </nav>

  
<nav>
    <a href="https:&#x2F;&#x2F;rune-rs.github.io">Home</a>
    <span class="dot-divider"></span>
    <a href="https:&#x2F;&#x2F;rune-rs.github.io/posts/">Posts</a>
    <span class="dot-divider"></span>
    <a href="https:&#x2F;&#x2F;rune-rs.github.io/play/">Playground</a>
</nav>

</header>


      
  <section class="container">
    <article>
      
        <h1 class="article-title"><a href="https:&#x2F;&#x2F;rune-rs.github.io&#x2F;posts&#x2F;tmir1&#x2F;" id="article-link">This month and a half in Rune</a></h1>
        
<ul class="frontmatter frontmatter-page" id="frontmatter">
    
    <li>John-John Tedro</li>
    <span class="dot-divider"></span>
    
    <li>
        <time class="article_time"  datetime="2020-10-19">October 19, 2020</time>
    </li>
    <span class="dot-divider"></span>
    <li> 3971 words </li>
    <span class="dot-divider" ></span>
    <li> 20 min </li>
</ul>

        <p>A bit more than one month ago <a href="https://www.reddit.com/r/rust/comments/in67d3/introducing_rune_a_new_stackbased_dynamic/">I announced Rune</a> ðŸ¥³. And the response so far has
been amazing.</p>
<p>A lot of <em>stuff</em> has happened since then, so in this post I'll detail some of
the developments since the initial announcement.</p>
<span id="continue-reading"></span>
<p>This is also an announcement for Rune <code>0.7</code>. But the exact number shouldn't be
taken too seriously given the experimental state of the project right now. In
the future we'll be trying to bake a release roughly once every month which
might or might not include breaking changes.</p>
<p>For those of you new to the project, Rune is an open source embeddable dynamic
programming language that compiles and runs on a virtual machine called
Runestick. It is designed to feel like Rust without types, and be about as fast
and convenient to use as Lua. You can read about it in <a href="https://rune-rs.github.io/book/">the foreword to the
book</a> which also explains why I started making a new programming language.</p>
<p>Feel free to <a href="https://www.reddit.com/r/rust/comments/jdvc8r/this_month_and_a_half_in_rune/"><strong>Discuss this on Reddit</strong></a>.</p>
<ul>
<li><a href="https://rune-rs.github.io/posts/tmir1/#welcome-to-the-playground">Welcome to the playground</a></li>
<li><a href="https://rune-rs.github.io/posts/tmir1/#modules-and-visibility">Modules and visibility</a></li>
<li><a href="https://rune-rs.github.io/posts/tmir1/#macros">Macros</a></li>
<li><a href="https://rune-rs.github.io/posts/tmir1/#println-and-formatargs">println! and FormatArgs</a></li>
<li><a href="https://rune-rs.github.io/posts/tmir1/#constant-evaluation">constant evaluation</a></li>
<li><a href="https://rune-rs.github.io/posts/tmir1/#better-iterator-support">Better iterator support</a></li>
<li><a href="https://rune-rs.github.io/posts/tmir1/#ide-support">IDE Support</a></li>
<li><a href="https://rune-rs.github.io/posts/tmir1/#full-changelog">Full Changelog</a></li>
</ul>
<h2 id="welcome-to-the-playground">Welcome to the playground</h2>
<p>You might have noticed that this blog post contains runnable sections of code,
like this:</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="true""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">const NAME = "Friend";

pub fn main() {
    println!("Hello, {}", NAME);
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">A code section you can edit</div>
</div>
<p>This is used to power the <a href="https://rune-rs.github.io/play/"><strong>Rune playground</strong></a>. A place that allow you to fiddle
with Rune online and share code snippets with others.</p>
<p>In order to accomplish this, we made sure Rune could compile and run on
<a href="https://webassembly.org/">WebAssembly</a>. And <a href="https://github.com/rune-rs/rune/tree/main/crates/rune-wasm">introduced a module</a> which provides an interface to the
compiler.</p>
<blockquote>
<p>The content of these snippets are currently stored in the URL, so try to keep
them small for others' sake!</p>
</blockquote>
<h2 id="modules-and-visibility">Modules and visibility</h2>
<p>We've taught rune to expand modules and respect visibility rules. This is a nice
feature that enabled better encapsulation and it brings the capabilities of Rune
more in line with Rust.</p>
<p>You can see basic modules in action with the following test case borrowed from
the <a href="https://doc.rust-lang.org/reference/visibility-and-privacy.html">Rust reference book</a> (ignore the unused warnings ðŸ˜‰):</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="true""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="{&quot;suppress_text_warnings&quot;: true}""
    >
    <div class="rune-editor">mod crate_helper_module {
    pub fn crate_helper() {}

    fn implementation_detail() {}
}

pub fn public_api() {}

pub mod submodule {
    use crate::crate_helper_module;

    pub fn my_method() {
        crate_helper_module::crate_helper();
    }

    fn my_implementation() {}

    mod test {
        fn test_my_implementation() {
            super::my_implementation();
        }
    }
}

pub fn main() {
    submodule::my_method();
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">Basic modules and visibility smoke test</div>
</div>
<p>This means that we've had to extend the existing bare bones system so that it
understands how to perform, and <em>cache</em> recursive imports and their visibility.
At this point it doesn't behave exactly like Rust. One example of this is that
conflicting wildcard imports simply override each other instead of <a href="https://play.rust-lang.org/?version=stable&amp;mode=debug&amp;edition=2018&amp;gist=3c0100d683d19c23168fa23e57483d2a">being marked
as ambiguous</a>:</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="true""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">mod a { pub struct Foo; }
mod b { pub struct Foo; }
use {a::*, b::*};
pub fn main() { Foo is b::Foo }</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">The last wildcard import wins</div>
</div>
<p>But we do have the basic rules down <a href="https://doc.rust-lang.org/reference/visibility-and-privacy.html">as outlined in the reference</a>.</p>
<ol>
<li>If an item is public, then it can be accessed externally from some module m
if you can access all the item's ancestor modules from m. You can also
potentially be able to name the item through re-exports. See below.</li>
<li>If an item is private, it may be accessed by the current module and its
descendants.</li>
</ol>
<p>What hasn't been implemented yet is the separation between between the extern
prelude and crate root, as described <a href="https://gist.github.com/Koxiaet/8c05ebd4e0e9347eb05f265dfb7252e1#2018-edition">in this excellent post by Koxiaet</a>. This
would require refactoring some tricky parts of the module system, but it <a href="https://github.com/rune-rs/rune/issues/160">is on
the roadmap</a>.</p>
<h2 id="macros">Macros</h2>
<p>We've taught Rune how to parse and execute macros. Macros are compile-time
procedures which consumes one token stream and transforms it to produce another
in its place.</p>
<p>This is of course <em>a bit complicated</em>. You have to take care that macro
expansion happens in a manner that is well integrated into the rest of the
compilation. Too early, and the items produces in the macro for example can't
see imports. Too late, and it can't produce them. There are <a href="https://github.com/rune-rs/rune/issues/154">still a few things</a>
that need to be figured out. But it's shaping up pretty well.</p>
<p>Rune support for macros is currently <em>experimental</em>. Macros are restricted to
native modules. This makes matters easier, because native modules are written in
Rust and are therefore compiled <em>before</em> any Rune program using them. Neatly
getting around the issue that you have to compile the macro before it can be
run.</p>
<p>We've tried to learn about macros from Rust. Parsing in Rune has been designed
in a way so that it can be re-used directly within macros, similarly to what you
get with the <a href="https://docs.rs/syn/1"><code>syn</code> crate</a>. We also provide our own version of the <a href="https://docs.rs/quote/1"><code>quote!</code>
macro</a> to ergonomically produce token streams.</p>
<p>The following is an example macro that comes with the <code>std::experiments</code> crate.
It translates &quot;stringy math&quot; into rune expressions:</p>
<pre data-lang="rust" style="background-color:#383838;color:#e6e1dc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#cc7833;">use </span><span>rune::ast;
</span><span style="color:#cc7833;">use </span><span>rune::macros;
</span><span style="color:#cc7833;">use </span><span>rune::{quote, Parser, Spanned, TokenStream};
</span><span style="color:#cc7833;">use </span><span>runestick::SpannedError;
</span><span>
</span><span style="color:#95815e;">/// Implementation for the `stringy_math!` macro.
</span><span style="color:#cc7833;">pub</span><span>(</span><span style="color:#cc7833;">crate</span><span>) </span><span style="font-style:italic;color:#6e9cbe;">fn </span><span style="color:#ffc66d;">stringy_math</span><span>(</span><span style="font-style:italic;color:#fd971f;">stream</span><span>: </span><span style="color:#cc7833;">&amp;</span><span>TokenStream) -&gt; runestick::</span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>&lt;TokenStream&gt; {
</span><span>    </span><span style="font-style:italic;color:#6e9cbe;">let </span><span style="color:#cc7833;">mut</span><span> parser </span><span style="color:#cc7833;">= </span><span>Parser::from_token_stream(stream);
</span><span>
</span><span>    </span><span style="font-style:italic;color:#6e9cbe;">let </span><span style="color:#cc7833;">mut</span><span> output </span><span style="color:#cc7833;">= </span><span>quote!(</span><span style="color:#a5c261;">0</span><span>);
</span><span>
</span><span>    </span><span style="color:#cc7833;">while !</span><span>parser.</span><span style="color:#da4939;">is_eof</span><span>()</span><span style="color:#cc7833;">? </span><span>{
</span><span>        </span><span style="font-style:italic;color:#6e9cbe;">let</span><span> op </span><span style="color:#cc7833;">=</span><span> parser.parse::&lt;ast::Ident&gt;()</span><span style="color:#cc7833;">?</span><span>;
</span><span>        </span><span style="font-style:italic;color:#6e9cbe;">let</span><span> arg </span><span style="color:#cc7833;">=</span><span> parser.parse::&lt;ast::Expr&gt;()</span><span style="color:#cc7833;">?</span><span>;
</span><span>
</span><span>        output </span><span style="color:#cc7833;">= match </span><span>macros::resolve(op)</span><span style="color:#cc7833;">?</span><span>.</span><span style="color:#da4939;">as_ref</span><span>() {
</span><span>            </span><span style="color:#c1be91;">&quot;add&quot; </span><span style="color:#cc7833;">=&gt; </span><span>quote!((</span><span style="color:#cc7833;">#</span><span>output) </span><span style="color:#cc7833;">+ #</span><span>arg),
</span><span>            </span><span style="color:#c1be91;">&quot;sub&quot; </span><span style="color:#cc7833;">=&gt; </span><span>quote!((</span><span style="color:#cc7833;">#</span><span>output) </span><span style="color:#cc7833;">- #</span><span>arg),
</span><span>            </span><span style="color:#c1be91;">&quot;div&quot; </span><span style="color:#cc7833;">=&gt; </span><span>quote!((</span><span style="color:#cc7833;">#</span><span>output) </span><span style="color:#cc7833;">/ #</span><span>arg),
</span><span>            </span><span style="color:#c1be91;">&quot;mul&quot; </span><span style="color:#cc7833;">=&gt; </span><span>quote!((</span><span style="color:#cc7833;">#</span><span>output) </span><span style="color:#cc7833;">* #</span><span>arg),
</span><span>            </span><span style="color:#cc7833;">_ =&gt; </span><span>{
</span><span>                </span><span style="color:#cc7833;">return </span><span style="font-style:italic;color:#6e9cbe;">Err</span><span>(SpannedError::msg(
</span><span>                    op.</span><span style="color:#da4939;">span</span><span>(),
</span><span>                    </span><span style="color:#c1be91;">&quot;unsupported operation&quot;</span><span>,
</span><span>                ).</span><span style="color:#da4939;">into</span><span>())
</span><span>            }
</span><span>        }
</span><span>    }
</span><span>
</span><span>    parser.</span><span style="color:#da4939;">eof</span><span>()</span><span style="color:#cc7833;">?</span><span>;
</span><span>    </span><span style="font-style:italic;color:#6e9cbe;">Ok</span><span>(output.</span><span style="color:#da4939;">into_token_stream</span><span>())
</span><span>}
</span></code></pre>
<p>You can try it out below:</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="true""
    rune-run-button="false""
    rune-options="""
    rune-experimental="true""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">use std::experiments::stringy_math;

pub fn main() {
    let value = stringy_math!(add 10 sub 5);
    println!("result: {}", value);
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">Use of the stringy_math! macro</div>
</div>
<p>Macros are intended to be a stable bedrock for language extension. To support
use-cases which can use a bit of custom syntax or behavior glued into a project.
A nice example of this in Rust is <a href="https://rocket.rs">Rocket</a>, which uses macros to great effect to
improve the ergonomics of writing web services. The hopes are that macros can be
used to provide similar experiences where appropriate in Rune.</p>
<p>The current macro system is also being dogfooded to provide a couple of utility
macros that Rust developers would expect like <code>println!</code>, which will be covered
in the next section.</p>
<h2 id="println-and-formatargs"><code>println!</code> and <code>FormatArgs</code></h2>
<p>In Rust, when you want to print something to stdout you can reach for the
<code>println!</code> macro.</p>
<pre data-lang="rust" style="background-color:#383838;color:#e6e1dc;" class="language-rust "><code class="language-rust" data-lang="rust"><span>println!(</span><span style="color:#c1be91;">&quot;Hello {:&gt;12}&quot;</span><span>, </span><span style="color:#c1be91;">&quot;World&quot;</span><span>);
</span></code></pre>
<p>The first argument in this macro is called a format string. And combined it
provides a convenient way for performing common text formatting operations in
Rust. Now Rune can also use a limited form of <code>println!</code>, and format arguments
in general.</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="true""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">pub fn main() {
    println!("Hello {:>12}", "World");
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">Formatting with println!</div>
</div>
<p>To implement string formatting like this we've added <code>FormatArgs</code>. A type that
implements <code>Parse</code> that can be used to add message formatting to any macro. The
full implementation of the <code>println!</code> is simply using it to format a string
which is passed to <code>std::io::println</code>.</p>
<pre data-lang="rust" style="background-color:#383838;color:#e6e1dc;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="font-style:italic;color:#6e9cbe;">fn </span><span style="color:#ffc66d;">println_macro</span><span>(</span><span style="font-style:italic;color:#fd971f;">stream</span><span>: </span><span style="color:#cc7833;">&amp;</span><span>TokenStream) -&gt; </span><span style="font-style:italic;color:#6e9cbe;">Result</span><span>&lt;TokenStream&gt; {
</span><span>    </span><span style="font-style:italic;color:#6e9cbe;">let </span><span style="color:#cc7833;">mut</span><span> p </span><span style="color:#cc7833;">= </span><span>Parser::from_token_stream(stream);
</span><span>    </span><span style="font-style:italic;color:#6e9cbe;">let</span><span> args </span><span style="color:#cc7833;">=</span><span> p.parse_all::&lt;macros::FormatArgs&gt;()</span><span style="color:#cc7833;">?</span><span>;
</span><span>
</span><span>    </span><span style="font-style:italic;color:#6e9cbe;">let</span><span> expanded </span><span style="color:#cc7833;">=</span><span> args.</span><span style="color:#da4939;">expand</span><span>()</span><span style="color:#cc7833;">?</span><span>;
</span><span>    </span><span style="font-style:italic;color:#6e9cbe;">Ok</span><span>(quote!(std::io::println(</span><span style="color:#cc7833;">#</span><span>expanded)).</span><span style="color:#da4939;">into_token_stream</span><span>())
</span><span>}
</span></code></pre>
<p>To accomplish this, <code>FormatArgs</code> is actually expanded into two internal macros:</p>
<ul>
<li><code>#[builtin] template!(..)</code> which is the same macro produced by template
strings.</li>
<li><code>#[builtin] format!(..)</code> which produces a <code>Format</code> value that conveniently
implements <a href="https://rune-rs.github.io/book/template_literals.html#the-string_display-protocol">the <code>STRING_DISPLAY</code> protocol</a>.</li>
</ul>
<p>Strictly speaking, these expansions result in valid Rune. The <code>#[builtin]</code>
attribute modifies how the macros are looked up so that they are solely expanded
at compile time into the appropriate instructions. They are intended for
internal use only, so we'll probably restrict their use in the future. But for
now you can simply type out the equivalent code that is being generated to get a
better understanding for how they work ðŸ™ƒ.</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="true""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">use std::io;

pub fn main() {
    io::println(#[builtin] template! {
        "Hello ",
        #[builtin] format! {
            "World",
            width = 12,
            align = right
        }
    });
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">Using the built-in template! and format! macros directly</div>
</div>
<p>This also means that the following macros now also support formatting:</p>
<ul>
<li><code>panic!</code> to customize the panic message.</li>
<li><code>assert!</code> and <code>assert_eq!</code>.</li>
<li>The newly introduced <code>format!</code>, which produces a string directly.</li>
</ul>
<h2 id="constant-evaluation">constant evaluation</h2>
<p>Work has been started to support <em>constant evaluation</em>. Usually all code is
compiled to target the <a href="https://docs.rs/runestick/0">runestick virtual machine</a>, but constant evaluation
introduces a separate interpreted mode that the compiler can run directly.</p>
<p>A limited subset of the language is currently available in constant contexts,
this includes functions and <code>const</code> items. Which can do the following:</p>
<ul>
<li>Numerical computations.</li>
<li>Simple control flow through <code>if</code>, <code>while</code>, and <code>loop</code>.</li>
<li>A number of binary operators.</li>
<li>String operations and templates.</li>
<li>... and a bit more</li>
</ul>
<p>Native functions are currently <em>not</em> visible during constant evaluation. This
could be enabled, but we still need to decide which scope to limit constant
evaluation to. I.e. do we want to be able to perform database requests during
constant evaluation? In practice this will probably be determined selectively.
Constant values are aggressively cached, so we should probably require a proof
obligation that they have no side effects and leave more complex uses with
potential side effects to macros.</p>
<p>Here's an example of what you can do today with constant evaluation:</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="false""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">const fn greeting(name) {
    `Hello {name}`
}

/// Define a collection of predefined greetings.
const GREETINGS = [
    greeting("Stranger"),
    greeting("Jane"),
    greeting("John"),
    greeting("Mio"),
];

pub fn main() {
    let rng = rand::Pcg64::new();
    let greetings = GREETINGS;

	println(greetings[rng.int_range(0, greetings.len())]);
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">Asynchronous programming using select</div>
</div>
<p>As a bonus, here's the <a href="https://rune-rs.github.io/play/">Fibonacci example used in the playground</a> as a constant
function. We only need to introduce <code>const</code> to the <code>fn</code> item for it to work.</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="false""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">const fn fib(n) {
    if n <= 1 {
        n
    } else {
        fib(n - 1) + fib(n - 2)
    }
}

pub fn main() {
    fib(15)
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">Asynchronous programming using select</div>
</div>
<h2 id="better-iterator-support">Better iterator support</h2>
<p>Iterators have gotten a bit of love in that they are now represented as a single
consistent type called <code>Iterator</code>. This holds all the iterators transformation
methods like <code>map</code>, <code>filter</code>, and <code>rev</code>. Any function producing an iterator
should produce an instance of <code>Iterator</code>.</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="true""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">struct Foo {
    value,
}

pub fn main() {
    let values = [1, "foo", Foo { value: 42 }];

    for v in values.iter().rev() {
        println!("{:?}", v);
    }
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">Reversing an iterator</div>
</div>
<p>We've also added two collect functions: <code>collect::&lt;Vec&gt;</code> and <code>collect::&lt;Object&gt;</code>.</p>
<div class="rune big"
    rune-update-url="false"
    rune-run-on-change="true""
    rune-run-button="false""
    rune-options="""
    rune-experimental="false""
    rune-instructions="""
    rune-config="""
    >
    <div class="rune-editor">struct Foo {
    value,
}

pub fn main() {
    let values = [1, "foo", Foo { value: 42 }];

    values.iter().filter(|v| v is Foo).collect::<Vec>()
}</div>
    <div class="rune-console">
        <div class="rune-control">
            <button class="rune-button rune-run">Run</button>

            <label class="rune-option">
                <input class="rune-checkbox instructions" type="checkbox" title="Show compiled instructions"></input>
                Instructions
            </label>

            <label class="rune-option">
                <input class="rune-checkbox run-on-change" type="checkbox" title="Show compiled instructions"></input>
                Run on change
            </label>
        </div>
        <div class="rune-output primary"></div>
        <div class="rune-output diagnostics"></div>
        <div class="rune-output instructions"></div>
    </div>
    <div class="rune-footnote">Apply filter to an iterator and collecting the result</div>
</div>
<blockquote>
<p>Why two functions? Well, Rune doesn't have <a href="https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.collect">type annotations to select the
desired output type</a>. This solution should be considered preliminary, because
this might be a good case where <a href="https://en.wikipedia.org/wiki/Gradual_typing">gradual typing</a> might be used in the future.</p>
</blockquote>
<h2 id="ide-support">IDE Support</h2>
<p>Work has been started to provide editor support through <a href="https://marketplace.visualstudio.com/items?itemName=udoprog.rune-vscode">rune-vscode</a>. A Visual
Studio Code extension that adds syntax highlighting and integration with the
Rune language server.</p>
<p><img src="https://user-images.githubusercontent.com/111092/93017349-32a28f00-f5c8-11ea-9301-5fcb586c89c8.gif" alt="Showcasing go to definitions" /></p>
<p>While it works pretty well for now, don't get too excited. There's still a lot
of work to do. Next I'll detail the most important tasks yet to be done.</p>
<p>We absolutely <a href="https://github.com/rune-rs/rune/issues/73">need to support external definition files</a> for this to work well.
Right now the language server simply includes all the native modules that
<a href="https://github.com/rune-rs/rune/tree/main/crates/rune-modules">happen to be bundled with Rune</a>. We don't see custom modules included
elsewhere. The solution is to have support for dynamically loading separate
declaration files which defines the content of native modules. Like with
<a href="https://www.typescriptlang.org/docs/handbook/declaration-files/by-example.html"><code>.d.ts</code> files in TypeScript</a>.</p>
<p>The language server is using the same compiler as Rune. Our hope is to be able
to maintain the same internals and avoid as much duplication as possible. To
accomplish this, we're looking closely at rust-analyzer. Specifically <a href="https://rust-analyzer.github.io/blog/2020/09/16/challeging-LR-parsing.html">their
approach to parsing</a> which provides better error resilience in order to give the
user a better experience when challenged with incomplete code. Something we
hopefully can work incrementally towards.</p>
<h2 id="fixing-a-common-miscompilation-in-rune">Fixing a common miscompilation in Rune</h2>
<p>The compiler has been redesigned to avoid a common root cause of
miscompilations. This is such an extensive topic that <a href="https://rune-rs.github.io/posts/common-miscompilation/">it deserves its own
post</a>. But the cliff note is that the compiler has been redesigned in a way to
make a class of bugs harder to introduce.</p>
<p>Relevant issues: <a href="https://github.com/rune-rs/rune/pull/118">#118</a>, <a href="https://github.com/rune-rs/rune/pull/127">#127</a>.</p>
<h2 id="contributors">Contributors</h2>
<p>A number of people have provided code, time, and extensive feedback to Rune over
the last development period.</p>
<ul>
<li><a href="https://github.com/aspenluxxxy">aspenluxxxy</a></li>
<li><a href="https://github.com/dillonhicks">dillonhicks</a></li>
<li><a href="https://github.com/genusistimelord">genusistimelord</a></li>
<li><a href="https://github.com/killercup">killercup</a></li>
<li><a href="https://github.com/macginitie">macginitie</a></li>
<li><a href="https://github.com/MinusGix">MinusGix</a></li>
<li><a href="https://github.com/seanchen1991">seanchen1991</a></li>
<li><a href="https://github.com/shekohex">shekohex</a></li>
<li><a href="https://github.com/Sparkpin">Sparkpin</a></li>
<li><a href="https://github.com/stoically">stoically</a></li>
</ul>
<p>Thank you all very much for helping make Rune better!</p>
<h2 id="full-changelog">Full Changelog</h2>
<h3 id="added">Added</h3>
<ul>
<li>The Rune project now has a Code of Conduct (<a href="https://github.com/rune-rs/rune/pull/12">#12</a>).</li>
<li>Support for bitwise operations on numbers (<a href="https://github.com/rune-rs/rune/pull/13">#13</a>, <a href="https://github.com/rune-rs/rune/pull/20">#20</a>).</li>
<li>Book now has support for highlighting <code>rune</code> blocks (<a href="https://github.com/rune-rs/rune/pull/14">#14</a>).</li>
<li>Preliminary support for modules without visibility (<a href="https://github.com/rune-rs/rune/pull/16">#16</a>, <a href="https://github.com/rune-rs/rune/pull/17">#17</a>).</li>
<li>Debug information for function variable names now reflect source (<a href="https://github.com/rune-rs/rune/pull/24">#24</a>).</li>
<li>Initial support for macros (<a href="https://github.com/rune-rs/rune/pull/29">#29</a>, <a href="https://github.com/rune-rs/rune/pull/30">#30</a>, <a href="https://github.com/rune-rs/rune/pull/31">#31</a>, <a href="https://github.com/rune-rs/rune/pull/114">#114</a>, <a href="https://github.com/rune-rs/rune/pull/135">#135</a>, <a href="https://github.com/rune-rs/rune/pull/136">#136</a>,
<a href="https://github.com/rune-rs/rune/pull/137">#137</a>, <a href="https://github.com/rune-rs/rune/pull/138">#138</a>, <a href="https://github.com/rune-rs/rune/pull/141">#141</a>, <a href="https://github.com/rune-rs/rune/pull/142">#142</a>, <a href="https://github.com/rune-rs/rune/pull/143">#143</a>, <a href="https://github.com/rune-rs/rune/pull/144">#144</a>).</li>
<li>Add cargo build cache (<a href="https://github.com/rune-rs/rune/pull/36">#36</a>) (thanks <a href="https://github.com/shekohex">shekohex</a>!).</li>
<li>Rust <code>quote!</code> macro for Rune macro authors (<a href="https://github.com/rune-rs/rune/pull/34">#34</a>).</li>
<li>Support for object- and tuple-like field assignments (<a href="https://github.com/rune-rs/rune/pull/38">#38</a>, <a href="https://github.com/rune-rs/rune/pull/39">#39</a>, <a href="https://github.com/rune-rs/rune/pull/40">#40</a>,
<a href="https://github.com/rune-rs/rune/pull/66">#66</a>).</li>
<li>Support for lazy evaluation for and/or (<code>&amp;&amp;</code> / <code>||</code>) (<a href="https://github.com/rune-rs/rune/pull/50">#50</a>) (thanks
<a href="https://github.com/seanchen1991">seanchen1991</a>!).</li>
<li>Add <code>AsTokens</code>, <code>FromValue</code>, <code>ToValue</code>, and <code>Spanned</code> derives (<a href="https://github.com/rune-rs/rune/pull/41">#41</a>, <a href="https://github.com/rune-rs/rune/pull/85">#85</a>,
<a href="https://github.com/rune-rs/rune/pull/87">#87</a>, <a href="https://github.com/rune-rs/rune/pull/88">#88</a>, <a href="https://github.com/rune-rs/rune/pull/113">#113</a>).</li>
<li>Visual studio code extension with syntax highlighting and basic language
server (<a href="https://github.com/rune-rs/rune/pull/46">#46</a>, <a href="https://github.com/rune-rs/rune/pull/47">#47</a>, <a href="https://github.com/rune-rs/rune/pull/48">#48</a>, <a href="https://github.com/rune-rs/rune/pull/60">#60</a>, <a href="https://github.com/rune-rs/rune/pull/74">#74</a>) (thanks <a href="https://github.com/killercup">killercup</a>!).
<ul>
<li>As-you-type building (<a href="https://github.com/rune-rs/rune/pull/49">#49</a>).</li>
<li>Jump to definitions (<a href="https://github.com/rune-rs/rune/pull/61">#61</a>).</li>
<li>Multifile project support (<a href="https://github.com/rune-rs/rune/pull/64">#64</a>).</li>
<li>Automatic downloading of language server binary (<a href="https://github.com/rune-rs/rune/pull/69">#69</a>).</li>
</ul>
</li>
<li>Non-zero exit status on script errors (<a href="https://github.com/rune-rs/rune/issues/58">#58</a>, <a href="https://github.com/rune-rs/rune/pull/59">#59</a>) (thanks <a href="https://github.com/killercup">killercup</a>!).</li>
<li>Improve CLI by parsing arguments using <a href="https://docs.rs/structopt"><code>structopt</code></a> (<a href="https://github.com/rune-rs/rune/pull/51">#51</a>) (thanks
<a href="https://github.com/shekohex">shekohex</a>!).</li>
<li>Executing functions in the virtual machine can use external references
(<a href="https://github.com/rune-rs/rune/pull/52">#52</a>).</li>
<li>Remove unused instruction in <code>loop</code> (<a href="https://github.com/rune-rs/rune/pull/53">#53</a>) (thanks <a href="https://github.com/genusistimelord">genusistimelord</a>!).</li>
<li>Tweak module dependencies to use native Rust modules (<a href="https://github.com/rune-rs/rune/pull/54">#54</a>) (thanks
<a href="https://github.com/killercup">killercup</a>!).</li>
<li>Internal changes to support a future C FFI (<a href="https://github.com/rune-rs/rune/pull/55">#55</a>).</li>
<li>Improving module API (<a href="https://github.com/rune-rs/rune/pull/56">#56</a>).</li>
<li>Extending <code>http</code> module to deserialize JSON directly (<a href="https://github.com/rune-rs/rune/pull/57">#57</a>) (thanks
<a href="https://github.com/killercup">killercup</a>!).</li>
<li>Automatic build releases on tags (<a href="https://github.com/rune-rs/rune/pull/68">#68</a>).</li>
<li>Fixed locals bug with breaking control in the middle of an index get operation
(<a href="https://github.com/rune-rs/rune/pull/71">#71</a>).</li>
<li>Community site at https://rune-rs.github.io (<a href="https://github.com/rune-rs/rune/pull/75">#75</a>).</li>
<li>Add WASM-based Playground to community site https://rune-rs.github.io (<a href="https://github.com/rune-rs/rune/pull/77">#77</a>).</li>
<li>Support for limiting execution of <code>rune-wasm</code> (<a href="https://github.com/rune-rs/rune/pull/80">#80</a>).</li>
<li>Support for modules, imports, re-exports, visibility, and path resolution
(<a href="https://github.com/rune-rs/rune/pull/83">#83</a>, <a href="https://github.com/rune-rs/rune/pull/92">#92</a>, <a href="https://github.com/rune-rs/rune/pull/98">#98</a>, <a href="https://github.com/rune-rs/rune/pull/124">#124</a>, <a href="https://github.com/rune-rs/rune/pull/125">#125</a>, <a href="https://github.com/rune-rs/rune/pull/128">#128</a>, <a href="https://github.com/rune-rs/rune/pull/129">#129</a>, <a href="https://github.com/rune-rs/rune/pull/130">#130</a>, <a href="https://github.com/rune-rs/rune/pull/131">#131</a>, <a href="https://github.com/rune-rs/rune/pull/133">#133</a>,
<a href="https://github.com/rune-rs/rune/pull/134">#134</a>, <a href="https://github.com/rune-rs/rune/pull/148">#148</a>, <a href="https://github.com/rune-rs/rune/pull/155">#155</a>) (thanks <a href="https://github.com/dillonhicks">dillonhicks</a>!).</li>
<li>Add WASM support for a couple of showcased rune modules (<a href="https://github.com/rune-rs/rune/pull/89">#89</a>).</li>
<li>Added runtime type information (RTTI) for values in Runestick (<a href="https://github.com/rune-rs/rune/pull/90">#90</a>, <a href="https://github.com/rune-rs/rune/pull/112">#112</a>).</li>
<li>Add a <code>rand</code> module to <code>rune-modules</code> (<a href="https://github.com/rune-rs/rune/pull/100">#100</a>) (thanks <a href="https://github.com/aspenluxxxy">aspenluxxxy</a>!).</li>
<li>Initial support for constant evaluation (<a href="https://github.com/rune-rs/rune/pull/93">#93</a>, <a href="https://github.com/rune-rs/rune/pull/94">#94</a>, <a href="https://github.com/rune-rs/rune/pull/99">#99</a>, <a href="https://github.com/rune-rs/rune/pull/104">#104</a>, <a href="https://github.com/rune-rs/rune/pull/105">#105</a>,
<a href="https://github.com/rune-rs/rune/pull/106">#106</a>, <a href="https://github.com/rune-rs/rune/pull/107">#107</a>, <a href="https://github.com/rune-rs/rune/pull/117">#117</a>, <a href="https://github.com/rune-rs/rune/pull/122">#122</a>, <a href="https://github.com/rune-rs/rune/pull/123">#123</a>, <a href="https://github.com/rune-rs/rune/pull/153">#153</a>).</li>
<li>Add <code>Args</code> implementation for <code>Vec</code> (<a href="https://github.com/rune-rs/rune/pull/147">#147</a>) (thanks <a href="https://github.com/MinusGix">MinusGix</a>!).</li>
<li>Export a <code>Function</code> variant called <code>SyncFunction</code> that is thread-safe (<a href="https://github.com/rune-rs/rune/pull/149">#149</a>,
<a href="https://github.com/rune-rs/rune/pull/151">#151</a>) (thanks <a href="https://github.com/MinusGix">MinusGix</a>!).</li>
<li>Support <code>move</code> modifier to async blocks and closures to take ownership of
values being used (<a href="https://github.com/rune-rs/rune/pull/152">#152</a>).</li>
<li>Basic <code>Iterator</code> support (<a href="https://github.com/rune-rs/rune/pull/156">#156</a>, <a href="https://github.com/rune-rs/rune/pull/157">#157</a>) (thanks <a href="https://github.com/MinusGix">MinusGix</a>!).</li>
<li>Support for calling protocol functions from native code using <code>Interface</code> (<a href="https://github.com/rune-rs/rune/pull/159">#159</a>).</li>
</ul>
<h3 id="changed">Changed</h3>
<ul>
<li>Make units more efficient by separating runtime and compile-time metadata (<a href="https://github.com/rune-rs/rune/pull/24">#24</a>).</li>
<li>Change the internal representation of <code>Item</code> to be more memory efficient (<a href="https://github.com/rune-rs/rune/pull/63">#63</a>).</li>
<li>Make the implementation of <code>ParseError</code> and <code>CompileError</code> more consistent (<a href="https://github.com/rune-rs/rune/pull/65">#65</a>).</li>
<li>Remove the <code>rune-testing</code> module (<a href="https://github.com/rune-rs/rune/pull/67">#67</a>).</li>
<li>Made evaluation order of index set operations the same as Rust (<a href="https://github.com/rune-rs/rune/pull/70">#70</a>).</li>
<li>Make hashing less error prone (<a href="https://github.com/rune-rs/rune/pull/72">#72</a>).</li>
<li>Various parser changes and tests (<a href="https://github.com/rune-rs/rune/pull/110">#110</a>).</li>
<li>Various internal changes (<a href="https://github.com/rune-rs/rune/pull/103">#103</a>, <a href="https://github.com/rune-rs/rune/pull/108">#108</a>, <a href="https://github.com/rune-rs/rune/pull/109">#109</a>).</li>
<li>Parser simplifications (<a href="https://github.com/rune-rs/rune/pull/120">#120</a>, <a href="https://github.com/rune-rs/rune/pull/121">#121</a>).</li>
<li>Negative literals are handled as expressions (<a href="https://github.com/rune-rs/rune/pull/132">#132</a>).</li>
<li>Syntax for template strings now follows EcmaScript (<a href="https://github.com/rune-rs/rune/pull/145">#145</a>).</li>
</ul>
<h3 id="fixed">Fixed</h3>
<ul>
<li>Introduced custom highlight.js to fix issue with hidden lines in the book
(<a href="https://github.com/rune-rs/rune/issues/10">#10</a>).</li>
<li>Semi-colons in blocks weren't required, they now are (<a href="https://github.com/rune-rs/rune/pull/32">#32</a>).</li>
<li>Fixed field assignments (<a href="https://github.com/rune-rs/rune/pull/38">#38</a>, <a href="https://github.com/rune-rs/rune/pull/40">#40</a>) (thanks <a href="https://github.com/MinusGix">MinusGix</a>!).</li>
<li>Book typos (<a href="https://github.com/rune-rs/rune/pull/11">#11</a>, <a href="https://github.com/rune-rs/rune/pull/18">#18</a>, <a href="https://github.com/rune-rs/rune/pull/28">#28</a>, <a href="https://github.com/rune-rs/rune/issues/37">#37</a>) (thanks <a href="https://github.com/Sparkpin">Sparkpin</a>, <a href="https://github.com/seanchen1991">seanchen1991</a>,
<a href="https://github.com/stoically">stoically</a>, and <a href="https://github.com/macginitie">macginitie</a>!).</li>
<li>Fix broken book links (<a href="https://github.com/rune-rs/rune/pull/84">#84</a>, <a href="https://github.com/rune-rs/rune/pull/86">#86</a>) (thanks <a href="https://github.com/dillonhicks">dillonhicks</a>!).</li>
<li>Fix pattern miscompilation (<a href="https://github.com/rune-rs/rune/pull/62">#62</a>).</li>
<li>Fixed bug with Closure optimization where it's being treated as a function
(<a href="https://github.com/rune-rs/rune/issues/21">#21</a>, <a href="https://github.com/rune-rs/rune/pull/22">#22</a>) (thanks <a href="https://github.com/MinusGix">MinusGix</a>!).</li>
<li>Fixed a number of clippy lints (<a href="https://github.com/rune-rs/rune/pull/35">#35</a>) (thanks <a href="https://github.com/shekohex">shekohex</a>!).</li>
<li>Fix using closures in literals, like <code>(0, || 42)</code> or <code>#{a: || 42}</code> (<a href="https://github.com/rune-rs/rune/pull/78">#78</a>).</li>
<li>Shared access guards didn't implement Drop allowing them to leak their guarded
value (<a href="https://github.com/rune-rs/rune/pull/119">#119</a>).</li>
</ul>

      
    </article>
  </section>

       

      
        <footer>
          
<ul class="social-list foot-list" >
    

    
    <li class="button extra-small font_faint">
        <a title="Read The Book" href="https://rune-rs.github.io&#x2F;book&#x2F;" target="_blank">
            <i class="fa-solid fa-book"></i>
            book
        </a>
    </li>
    

    
    <li class="button extra-small font_faint">
        <a title="Visit GitHub Project" href="https://github.com/rune-rs" target="_blank">
            <i class="fab fa-github"></i>
            rune-rs
        </a>
    </li>
    

    
    <li class="button extra-small font_faint">
        <a title="Join Community Discord" href="https:&#x2F;&#x2F;discord.gg&#x2F;v5AeNkT" target="_blank">
            <i class="fab fa-discord"></i>
            discord
        </a>
    </li>
    

    <li class="button extra-small font_faint">
        <a title="rust api docs" href="https:&#x2F;&#x2F;rune-rs.github.io/api/rune/">
            <i class="fab fa-rust"></i>
            rust docs (git)
        </a>
    </li>

    <li class="button extra-small font_faint">
        <a title="rune docs" href="https:&#x2F;&#x2F;rune-rs.github.io/docs/">
            <i class="fa fa-book"></i>
            rune docs (git)
        </a>
    </li>

    
    <li class="button extra-small font_faint">
        <a href="https:&#x2F;&#x2F;rune-rs.github.io/rss.xml" target ="_blank">
            <i class="fas fa-rss"></i>
            rss
        </a>
    </li>
    
</ul>

        </footer>
      
    </body>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js" integrity="sha512-GZ1RIgZaSc8rnco/8CXfRdCpDxRCphenIiZ2ztLy3XQfCbQUSCuk8IudvNHxkRA3oUg6q0qejgN/qqyG1duv5Q==" crossorigin="anonymous"></script>
    <script type="text/javascript"  src="https:&#x2F;&#x2F;rune-rs.github.io/ace/mode-rune.js"></script>
    <script type="text/javascript"  src="https:&#x2F;&#x2F;rune-rs.github.io/js/rune.js"></script>
    <script type="text/javascript"  src="https:&#x2F;&#x2F;rune-rs.github.io/index.js"></script>
</html>
